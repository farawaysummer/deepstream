<?xml version="1.0" encoding="UTF-8"?>
<sqls>
    <sql name="selectHIS">
        <![CDATA[
SELECT A.OPC_ID,
(SELECT VVALUE FROM HMISW2003.SYSVAR WHERE VNAME = 'ORG_CODE' AND LENGTH(VVALUE) = 8 AND ROWNUM = 1)		AS	ORG_CODE	,--	医疗机构代码	S3	AN..10	P	医疗机构代码基础字典库 NBD02.00.002 与就诊信息中clinic_id一致参考格式clinic_id=门诊号+接诊医生编号（不是五位的话在左边用0补足五位）+分院号（总院为00）
 A.OPC_NO	AS	CLINIC_ID	,--	接诊编号	N	N..25	P
D.CHD_ID	AS	NO	,--	文书序号	S1	AN..8	P	病历的文书序号
(SELECT b.DEPT_ID FROM WDHIS.OIS_WORK_LOG B WHERE A.OPC_ID = B.OPC_ID AND B.EMP_ID=d.create_EMPID AND ROWNUM=1 ) AS	DEPT_CODE	,--	科室编号	S3	AN..8		中心科室库 NBD02.00.001
 A.OPC_NO	AS	REGISTER_ID	,--	门诊号	S1	AN..30		与就诊信息中REGISTER_ID一致 参考格式REGISTER_ID =G是固定开头+分院号+门诊号
A.CARD_DATA	AS	CARDID	,--	就诊卡号	S1	AN..128	Y
d.create_EMPID	AS	EMP_ID	,--	医生编号	S3	N..10	Y	中心人员库NBD03.00.001	20220419调整必填
 (select AA.BRBH    FROM HMISW2003.MZGHXX AA  where Aa.MZH=A.OPC_NO    )	AS	PAT_NO	,--	病历号	S1	AN..30	Y	在医院内部的病人唯一识别号
  (select AA.BRBH    FROM HMISW2003.MZGHXX AA  where Aa.MZH=A.OPC_NO   )	AS	PERSONID	,--	内部号	S1	AN..22	P
C.NAME	AS	NAME	,--	患者姓名	S1	AN..32	Y
decode(C.SEX,'1','1','2','2','9','9','0')	AS	SEX	,--	性别	S3	AN1	Y	人的性别代码 NBP00.00.003(GB/T 2261.1-2003)	 性别(1=男/2=女/3=不详/9=其它)
C.DATE_OF_BIRTH	AS	BIRTHDAY	,--	出生日期	D	D8
 Trunc((MONTHS_BETWEEN(A.REG_DATE,C.DATE_OF_BIRTH)) / 12)		AS	AGE	,--	年龄（岁）	S1	AN..16		年龄满1周岁的实足年龄
case when (Trunc((MONTHS_BETWEEN(A.REG_DATE,C.DATE_OF_BIRTH)) / 12)	) >=1 then 0 else  (Trunc((MONTHS_BETWEEN(A.REG_DATE,C.DATE_OF_BIRTH)) )	)  end  	AS	AGE2	,--	年龄（月）	S1	AN..16		年龄不足1周岁的实足年龄	 */
'01'	AS	CF_TYPE	,--	证件类型	S3	AN2		个体标识号类别代码CV0100.02
C.ID_CARD AS	IDCARD	,--	证件号码	S1	AN..18
A.INSURANCE_NO	AS	CARDNUM	,--	保险号码	S1	AN..20
D.CREATE_TIME	AS	CLINIC_TIME	,--	就诊日期	DT	DT15	Y
(SELECT b.CLINIC_TYPE FROM WDHIS.OIS_WORK_LOG B WHERE A.OPC_ID = B.OPC_ID AND B.EMP_ID=d.create_EMPID and rownum=1   )  	AS	IF_FIRSTVISIT	,--	初诊标志	S2	N1	Y	1急诊，2初诊，3复诊,4会诊
  NVL ( (SELECT LISTAGG (name, ',')within group (order by name)
                FROM WDHIS.pub_allergen, WDHIS.pat_allergen
               WHERE pat_id = c.pat_id AND allergen_id = id),
            '未发现')	AS	ALLERGIC_HISTORY	,--	过敏史	S1	AN..1000
 nvl(nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ROWNUM = 1
               AND (ED_CODE IN ('DE04.01.119.00','EMR142','EMR011') or ED_CODE like '%主诉%')),
               (SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND (ED_CODE IN ('DE02.10.071.00','EMR140','EMR012','EMR141') or ED_CODE like '%病%史%')
               AND ROWNUM = 1)),'无')	AS	CHIEF_COMPLAINT	,--	病人主诉	S1	AN..4000	Y
   nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND (ED_CODE IN ('DE02.10.071.00','EMR140','EMR012','EMR141') or ED_CODE like '%病%史%')
               AND ROWNUM = 1),'无')	AS	HPC	,--	现病史	S1	AN..4000	Y		20220419调整必填
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND (ED_CODE in ('DE02.10.099.00','DE02.10.103.00') or ED_CODE like '%既往史%') and rownum=1 ),'无')	AS	PMH	,--	既往史	S1	AN..4000	Y		20220419调整必填

 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ROWNUM = 1
               AND (ED_CODE IN ('DE04.10.258.00','EMR141') or ED_CODE like '%体格检查%')),'无殊')	AS	PHYSIQUE	,--	体格检查	S1	AN..4000	Y		20220419调整必填
(SELECT B.OPERTATION	 FROM WDHIS.OIS_WORK_LOG B WHERE A.OPC_ID = B.OPC_ID AND B.EMP_ID=d.create_EMPID   AND ROWNUM=1) AS	CLINIC_DISPOSE	,--	处理	S1	AN..4000
(SELECT b.DIAGNOSE FROM WDHIS.OIS_WORK_LOG B WHERE A.OPC_ID = B.OPC_ID AND B.EMP_ID=d.create_EMPID   AND ROWNUM=1)	AS	DIAGNOSE_NAME	,--	诊断	S1	AN..1000
	''		as DIAGNOSE_MEASUR,
(SELECT b.REMARKS FROM WDHIS.OIS_WORK_LOG B WHERE A.OPC_ID = B.OPC_ID AND B.EMP_ID=d.create_EMPID   AND ROWNUM=1)AS	KTDOC_REMARK	,--	备注	S1	AN..4000		除上述规范外的个性化字段，如流调史等，写在这里。要求自带标题，例：“流调史：患者无武汉旅行史”
D.CREATE_TIME	AS	CREATE_TIME	,--	书写时间	DT	DT15	Y
   nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.099.01'
               AND ROWNUM = 1),'无')	AS	HIS_EPIDEMIC	,--	流行病学史	S1	AN..2000		患者流行病学史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.026.00'
               AND ROWNUM = 1),'无')		AS	HIS_DISEASE_INC	,--	疾病史（含外伤）	S1	AN..2000		患者既往健康状况和疾病（含外伤）的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.101.00'
               AND ROWNUM = 1),'无')		AS	HIS_PRE_INOCULATION	,--	预防接种史	S1	AN..2000		患者预防接种情况的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.061.00'
               AND ROWNUM = 1),'无')		AS	HIS_OPERATION	,--	手术史	S1	AN..2000		患者既往接受手术/操作经历的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.099.02'
               AND ROWNUM = 1),'无')		AS	HIS_BIRTH	,--	出生史	S1	AN..2000		患者出生史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.099.03'
               AND ROWNUM = 1),'无')		AS	HIS_GROWN	,--	生长史	S1	AN..2000		患者	生长史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.099.04'
               AND ROWNUM = 1),'无')		AS	HIS_FEED	,--	喂养史	S1	AN..2000		患者喂养史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.100.00'
               AND ROWNUM = 1),'无')		AS	HIS_METACHYSIS	,--	输血史	S1	AN..2000		患者既往输血史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.097.00'
               AND ROWNUM = 1),'无')		AS	HIS_PERSONAL	,--	个人史	S1	AN..2000		患者个人生活习惯及有无烟、酒、药物等嗜好，职业与工作条件及有无工业毒物、粉尘、放射性物质接触史，有无冶游史的描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.098.00'
               AND ROWNUM = 1),'无')		AS	HIS_MARRY_CHILD	,--	婚育史	S1	AN..2000		患者婚育史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.102.00'
               AND ROWNUM = 1),'无')		AS	HIS_MENSES	,--	月经史	S1	AN..2000		患者月经史的详细描述	20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE02.10.103.00'
               AND ROWNUM = 1),'无')		AS	HIS_FAMILY	,--	家族史	S1	AN..2000		患者3代以内有血缘关系的家族成员中所患遗传疾病史的描述	20220419新增字段
 ''	AS	PULSE_RATE	,--	脉率	N	N..3		单位时间内脉搏次数的测量值，计量单位为次/min	20220419新增字段
substr((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='02'
               AND ROWNUM = 1),1,instr((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='02'
               AND ROWNUM = 1),'/')-1)	AS	SPB	,--	收缩压	N	N..3		上臂收缩压的测量值，计量单位为mmHg	20220419新增字段
substr((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='02'
               AND ROWNUM = 1),-1,length((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='02'
               AND ROWNUM = 1))-instr((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='02'
               AND ROWNUM = 1),'/'))	AS	DPB	,--	舒张压	N	N..3		上臂舒张压的测量值，计量单位为mmHg	20220419新增字段
(SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='HEIGHT'
               AND ROWNUM = 1)	AS	HEIGHT	,--	身高	N	N..5,1		身高的测量值，计量单位为cm	20220419新增字段
(SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='WEIGHT'
               AND ROWNUM = 1)	AS	WEIGHT	,--	体重	N	N..5,1		体重的测量值，计量单位为kg	20220419新增字段
''	AS	GESTATIONAL_AGE	,--	孕周（天）	N	N..3		孕妇的妊娠时长，计量单位为天	20220419新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='DE04.30.010.00'
               AND ROWNUM = 1),'无')		AS	ASSISTANT_EXAMINATION	,--	辅助检查项目	S1	AN..200		患者辅助检查、检验项目的通用名称	20220419新增字段
''	AS	PAIN_GRADE	,--	疼痛评分	S1	AN..200		患者的疼痛评分	20220419新增字段
''AS	EVALUATION_ALL	,--	各项评估	S1	AN..200		患者的各项评估	20220419新增字段
''	AS	WEST_DIAG_INHOS_DES	,--	健康教育	S1	AN..2000			20220419新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.02'
               AND ROWNUM = 1),'无')		AS	WZWS	,--	望诊-望神	S1	AN..200		望诊-望神的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.03'
               AND ROWNUM = 1),'无')	AS	WZWMS	,--	望诊-望面色	S1	AN..200		望诊-望面色的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.04'
               AND ROWNUM = 1),'无')	AS	WZWXT	,--	望诊-望形态	S1	AN..200		望诊-望形态的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.05'
               AND ROWNUM = 1),'无')	AS	WZWTLWGJQ	,--	望诊-望头颅五官九窍	S1	AN..200		望诊-望头颅五官九窍的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.06'
               AND ROWNUM = 1),'无')	AS	WZWPF	,--	望诊-望皮肤	S1	AN..200		望诊-望皮肤的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.07'
               AND ROWNUM = 1),'无')	AS	WZWLM	,--	望诊-望络脉	S1	AN..200		望诊-望络脉的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.08'
               AND ROWNUM = 1),'无')	AS	WZWPXWYFMW	,--	望诊-望排泄物与分泌物	S1	AN..200		望诊-望排泄物与分泌物的描述	20220522 新增字段
  nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.09'
               AND ROWNUM = 1),'')	AS	WZSDM	,--	望诊-舌代码	S3	N..2		初诊必填。中医望诊舌代码NBE01.00.012有多个时以“|”分隔	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.10'
               AND ROWNUM = 1),'无')	AS	WZS	,--	望诊-舌	S1	AN..200		望诊-舌的描述	20220522 新增字段
  nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.11'
               AND ROWNUM = 1),'')	AS	WZTDM	,--	望诊-苔代码	S3	N..2		初诊必填。中医望诊苔代码NBE01.00.013有多个时以“|”分隔	20220522 新增字段

  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.12'
               AND ROWNUM = 1),'无')	AS	WZT	,--	望诊-苔	S1	AN..200		望诊-苔的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.13'
               AND ROWNUM = 1),'无')	AS	WZQT1	,--	望诊-其他	S1	AN..200		望诊-其他的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.22'
               AND ROWNUM = 1),'无')	AS	WZTSY	,--	闻诊-听声音	S1	AN..200		闻诊-听声音的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.23'
               AND ROWNUM = 1),'无')	AS	WZXQW	,--	闻诊-嗅气味	S1	AN..200		闻诊-嗅气味的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.24'
               AND ROWNUM = 1),'无')	AS	WZQT2	,--	闻诊-其他	S1	AN..200		闻诊-其他的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.42'
               AND ROWNUM = 1),'无')	AS	WZHR	,--	问诊-寒热	S1	AN..200		问诊-寒热的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.43'
               AND ROWNUM = 1),'无')	AS	WZCH	,--	问诊-出汗	S1	AN..200		问诊-出汗的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.44'
               AND ROWNUM = 1),'无')	AS	WZTS	,--	问诊-头身	S1	AN..200		问诊-头身的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.45'
               AND ROWNUM = 1),'无')	AS	WZXXWF	,--	问诊-胸胁脘腹	S1	AN..200		问诊-胸胁脘腹的描述	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.46'
               AND ROWNUM = 1),'无')	AS	WZEM	,--	问诊-耳目	S1	AN..200		问诊-耳目的描述	20220522 新增字段
  nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.47'
               AND ROWNUM = 1),'')	AS	WZYSYKWDM	,--	问诊-饮食与口味代码	S3	N..2		初诊必填。中医问诊饮食与口味代码NBE01.00.014有多个时以“|”分隔	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.48'
               AND ROWNUM = 1),'无')	AS	WZYSYKW	,--	问诊-饮食与口味	S1	AN..200		问诊-饮食与口味的描述	20220522 新增字段
  nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.49'
               AND ROWNUM = 1),'')	AS	WZSMDM	,--	问诊-睡眠代码	S3	N..2		初诊必填。中医问诊睡眠代码NBE01.00.015有多个时以“|”分隔	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.50'
               AND ROWNUM = 1),'无')	AS	WZSM	,--	问诊-睡眠	S1	AN..200		问诊-睡眠的描述	20220522 新增字段
  nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.51'
               AND ROWNUM = 1),'')	AS	WZDBDM	,--	问诊-大便代码	S3	N..2		初诊必填。中医问诊大便代码NBE01.00.016有多个时以“|”分隔	20220522 新增字段
  nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.52'
               AND ROWNUM = 1),'无')	AS	WZDB	,--	问诊-大便	S1	AN..200		问诊-大便的描述	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.53'
               AND ROWNUM = 1),'无')		AS	WZXB	,--	问诊-小便	S1	AN..200		问诊-小便的描述	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.54'
               AND ROWNUM = 1),'无')		AS	WZFN	,--	问诊-妇女	S1	AN..200		患者为女性时必填	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.55'
               AND ROWNUM = 1),'无')		AS	WZXE	,--	问诊-小儿	S1	AN..200		问诊-小儿的描述	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.56'
               AND ROWNUM = 1),'无')		AS	WZQT3	,--	问诊-其他	S1	AN..200		问诊-其他的描述	20220522 新增字段
 nvl((SELECT LISTAGG (VALUE, ',')within group (order by VALUE)
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.57'
               AND ROWNUM = 1),'')		AS	QZMZDM	,--	切诊-脉诊代码	S3	N..2		初诊必填。中医切诊脉诊代码NBE01.00.017有多个时以“|”分隔	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.58'
               AND ROWNUM = 1),'无')		AS	QZMZ	,--	切诊-脉诊	S1	AN..200		切诊-脉诊的描述	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.59'
               AND ROWNUM = 1),'无')		AS	QZAZ	,--	切诊-按诊	S1	AN..200		切诊-按诊的描述	20220522 新增字段
 nvl((SELECT VALUE
          FROM WDHIS.EMR_CASE_HISTORY_STRUCT_DATA
         WHERE     CHD_ID = D.CHD_ID
               AND ED_CODE ='KT02.10.028.60'
               AND ROWNUM = 1),'无')		AS	QZQT	,--	切诊-其他	S1	AN..200		切诊-其他的描述	20220522 新增字段

NVL((SELECT  LISTAGG (AA.ICD, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='2'),(SELECT  LISTAGG (AA.ICD, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='3' ))AS	TCM_DIEASE_CODE	,--	中医病名代码	S1	AN..200	Y	患者在门（急）诊就诊时初步作出的疾病诊断在中医病名特定分类体系中的代码GB/T 15657-2021有多个时以“|”分隔	20220522 新增字段

NVL((SELECT  LISTAGG (AA.DISEASE_NAME, '|') within group (order by aA.DISEASE_NAME)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='2'),(SELECT  LISTAGG (AA.DISEASE_NAME, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='3' ))		AS	TCM_DIEASE_NAME	,--	中医病名名称	S1	AN..2000	Y	由医师根据患者就诊时的情况，综合分析所作出的中医诊断病名	20220522 新增字段

	NVL((SELECT  LISTAGG (AA.ICD, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='3'),(SELECT  LISTAGG (AA.ICD, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='2' ))		AS	TCM_SYNDROME_CODE	,--	中医证候代码	S1	AN..200	Y	患者在门（急）诊就诊时初步作出的疾病诊断在中医证候特定分类体系中的代码GB/T 15657-2021有多个时以“|”分隔	20220522 新增字段
NVL((SELECT  LISTAGG (AA.DISEASE_NAME, '|') within group (order by aA.DISEASE_NAME)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='3'),(SELECT  LISTAGG (AA.DISEASE_NAME, '|') within group (order by aA.ICD)

     FROM  WDHIS.OIS_DIAGNOSE AA, WDHIS.OIS_WORK_LOG BB, WDHIS.pub_diagnose CC
     WHERE  aA.CLINIC_ID =BB.CLINIC_ID AND AA.IS_TCM='1'  AND BB.OPC_ID=A.OPC_ID AND AA.ICD=CC.ICD  AND CC.DIAG_TYPE='2' ))AS	TCM_SYNDROME_NAME	,--	中医证候名称	20220522 新增字段
''	AS	THERAPEUTIC_METHOD_CODE	,--	治则治法代码	S1	AN..200		根据辨证结果采用的治则治法名称术语GB/T 15657-2021有多个时以“|”分隔	20220522 新增字段
''	AS	THERAPEUTIC_METHOD	,--	治则治法名称	S1	AN..2000		根据辨证结果采用的治则治法名称术语	20220522 新增字段
decode((select pd.diag_type from WDHIS.ois_diagnose od,WDHIS.pub_diagnose pd,WDHIS.ois_work_log owl where od.icd=pd.icd and pd.state=1 and od.is_main=1 and od.clinic_id=owl.clinic_id and owl.opc_id=a.opc_id and owl.emp_id=d.create_empid and owl.opc_id=a.opc_id),2,'2','3','2','1')   AS CASE_TYPE,--病历类型	S1	AN..1		1西医 2 中医
  D.CHD_ID||(SELECT VVALUE FROM HMISW2003.SYSVAR WHERE VNAME = 'ORG_CODE' AND LENGTH(VVALUE) = 8 AND ROWNUM = 1)	AS	 AUTO_ID ,-- varchar(64) COLLATE utf8_bin NOT NULL,

  D.CHD_ID||(SELECT VVALUE FROM HMISW2003.SYSVAR WHERE VNAME = 'ORG_CODE' AND LENGTH(VVALUE) = 8 AND ROWNUM = 1)	AS BASE_ID ,--varchar(64) COLLATE utf8_bin NOT NULL,
'宁波市北仑区第三人民医院'	 AS  HOSP_NAME,-- varchar(255) COLLATE utf8_bin DEFAULT NULL,
'73427532' AS  HOSP_ID,-- varchar(255) COLLATE utf8_bin DEFAULT NULL,
 (select AA.BRBH    FROM HMISW2003.MZGHXX AA  where Aa.MZH=A.OPC_NO   ) AS  PATIENT_ID,-- varchar(255) COLLATE utf8_bin DEFAULT NULL COMMENT '患者ID，关联MPI',
 A.OPC_NO	AS  LK_CLI_REG,
D.CREATE_TIME	 AS CREATE_DTIME,-- datetime DEFAULT NULL,
D.CHANGE_TIME	 AS  UPDATE_DTIME,-- datetime DEFAULT NULL,
'' 	AS   RECORD_DTIME ,--datetime DEFAULT NULL,
'' 	AS   RECORD_UPDATE_DTIME --datetime DEFAULT NULL

      FROM WDHIS.OIS_REG_INFO A,

       WDHIS.PAT_REGISTER C,
       WDHIS.EMR_CASE_HISTORY_DOCUMENT D,
       WDHIS.EMR_CASE_HISTORY_INFO E

 WHERE     A.OPC_ID = C.REG_ID
       AND C.SOURCE_TYPE = 1
       AND E.SOURCE_TYPE=1
       AND D.CH_ID = E.CH_ID
       AND C.REG_ID = E.REG_ID
       AND D.CH_ID = ?

        ]]>
    </sql>
    <sql name="insert">
        <![CDATA[
INSERT INTO NB_E12010000 (`ORG_CODE`,`CLINIC_ID`,`NO`,`DEPT_CODE`,`REGISTER_ID`,`CARDID`,`EMP_ID`,`PAT_NO`,`PERSONID`,`NAME`,`SEX`,`BIRTHDAY`,`AGE`,`AGE2`,`CF_TYPE`,`IDCARD`,`CARDNUM`,`CLINIC_TIME`,`IF_FIRSTVISIT`,`ALLERGIC_HISTORY`,`CHIEF_COMPLAINT`,`HPC`,`PMH`,`PHYSIQUE`,`CLINIC_DISPOSE`,`DIAGNOSE_NAME`,`DIAGNOSE_MEASUR`,`KTDOC_REMARK`,`CREATE_TIME`,`HIS_EPIDEMIC`,`HIS_DISEASE_INC`,`HIS_PRE_INOCULATION`,`HIS_OPERATION`,`HIS_BIRTH`,`HIS_GROWN`,`HIS_FEED`,`HIS_METACHYSIS`,`HIS_PERSONAL`,`HIS_MARRY_CHILD`,`HIS_MENSES`,`HIS_FAMILY`,`PULSE_RATE`,`SPB`,`DPB`,`HEIGHT`,`WEIGHT`,`GESTATIONAL_AGE`,`ASSISTANT_EXAMINATION`,`PAIN_GRADE`,`EVALUATION_ALL`,`WEST_DIAG_INHOS_DES`,`WZWS`,`WZWMS`,`WZWXT`,`WZWTLWGJQ`,`WZWPF`,`WZWLM`,`WZWPXWYFMW`,`WZSDM`,`WZS`,`WZTDM`,`WZT`,`WZQT1`,`WZTSY`,`WZXQW`,`WZQT2`,`WZHR`,`WZCH`,`WZTS`,`WZXXWF`,`WZEM`,`WZYSYKWDM`,`WZYSYKW`,`WZSMDM`,`WZSM`,`WZDBDM`,`WZDB`,`WZXB`,`WZFN`,`WZXE`,`WZQT3`,`QZMZDM`,`QZMZ`,`QZAZ`,`QZQT`,`TCM_DIEASE_CODE`,`TCM_DIEASE_NAME`,`TCM_SYNDROME_CODE`,`TCM_SYNDROME_NAME`,`THERAPEUTIC_METHOD_CODE`,`THERAPEUTIC_METHOD`,`AUTO_ID`,`HOSP_NAME`,`HOSP_ID`,`PATIENT_ID`,`LK_CLI_REG`,`CREATE_DTIME`,`UPDATE_DTIME`,`RECORD_DTIME`,`RECORD_UPDATE_DTIME`,`CASE_TYPE`)
 SELECT CAST(`ORG_CODE` AS STRING),
CAST(`CLINIC_ID` AS STRING),
CAST(`NO` AS STRING),
CAST(`DEPT_CODE` AS STRING),
CAST(`REGISTER_ID` AS STRING),
CAST(`CARDID` AS STRING),
CAST(`EMP_ID` AS STRING),
CAST(`PAT_NO` AS STRING),
CAST(`PERSONID` AS STRING),
CAST(`NAME` AS STRING),
CAST(`SEX` AS STRING),
CAST(`BIRTHDAY` AS STRING),
CAST(`AGE` AS STRING),
CAST(`AGE2` AS STRING),
CAST(`CF_TYPE` AS STRING),
CAST(`IDCARD` AS STRING),
CAST(`CARDNUM` AS STRING),
CAST(`CLINIC_TIME` AS STRING),
CAST(`IF_FIRSTVISIT` AS STRING),
CAST(`ALLERGIC_HISTORY` AS STRING),
CAST(`CHIEF_COMPLAINT` AS STRING),
CAST(`HPC` AS STRING),
CAST(`PMH` AS STRING),
CAST(`PHYSIQUE` AS STRING),
CAST(`CLINIC_DISPOSE` AS STRING),
CAST(`DIAGNOSE_NAME` AS STRING),
CAST(`DIAGNOSE_MEASUR` AS STRING),
CAST(`KTDOC_REMARK` AS STRING),
CAST(`CREATE_TIME` AS STRING),
CAST(`HIS_EPIDEMIC` AS STRING),
CAST(`HIS_DISEASE_INC` AS STRING),
CAST(`HIS_PRE_INOCULATION` AS STRING),
CAST(`HIS_OPERATION` AS STRING),
CAST(`HIS_BIRTH` AS STRING),
CAST(`HIS_GROWN` AS STRING),
CAST(`HIS_FEED` AS STRING),
CAST(`HIS_METACHYSIS` AS STRING),
CAST(`HIS_PERSONAL` AS STRING),
CAST(`HIS_MARRY_CHILD` AS STRING),
CAST(`HIS_MENSES` AS STRING),
CAST(`HIS_FAMILY` AS STRING),
CAST(`PULSE_RATE` AS STRING),
CAST(`SPB` AS STRING),
CAST(`DPB` AS STRING),
CAST(`HEIGHT` AS STRING),
CAST(`WEIGHT` AS STRING),
CAST(`GESTATIONAL_AGE` AS STRING),
CAST(`ASSISTANT_EXAMINATION` AS STRING),
CAST(`PAIN_GRADE` AS STRING),
CAST(`EVALUATION_ALL` AS STRING),
CAST(`WEST_DIAG_INHOS_DES` AS STRING),
CAST(`WZWS` AS STRING),
CAST(`WZWMS` AS STRING),
CAST(`WZWXT` AS STRING),
CAST(`WZWTLWGJQ` AS STRING),
CAST(`WZWPF` AS STRING),
CAST(`WZWLM` AS STRING),
CAST(`WZWPXWYFMW` AS STRING),
CAST(`WZSDM` AS STRING),
CAST(`WZS` AS STRING),
CAST(`WZTDM` AS STRING),
CAST(`WZT` AS STRING),
CAST(`WZQT1` AS STRING),
CAST(`WZTSY` AS STRING),
CAST(`WZXQW` AS STRING),
CAST(`WZQT2` AS STRING),
CAST(`WZHR` AS STRING),
CAST(`WZCH` AS STRING),
CAST(`WZTS` AS STRING),
CAST(`WZXXWF` AS STRING),
CAST(`WZEM` AS STRING),
CAST(`WZYSYKWDM` AS STRING),
CAST(`WZYSYKW` AS STRING),
CAST(`WZSMDM` AS STRING),
CAST(`WZSM` AS STRING),
CAST(`WZDBDM` AS STRING),
CAST(`WZDB` AS STRING),
CAST(`WZXB` AS STRING),
CAST(`WZFN` AS STRING),
CAST(`WZXE` AS STRING),
CAST(`WZQT3` AS STRING),
CAST(`QZMZDM` AS STRING),
CAST(`QZMZ` AS STRING),
CAST(`QZAZ` AS STRING),
CAST(`QZQT` AS STRING),
CAST(`TCM_DIEASE_CODE` AS STRING),
CAST(`TCM_DIEASE_NAME` AS STRING),
CAST(`TCM_SYNDROME_CODE` AS STRING),
CAST(`TCM_SYNDROME_NAME` AS STRING),
CAST(`THERAPEUTIC_METHOD_CODE` AS STRING),
CAST(`THERAPEUTIC_METHOD` AS STRING),
CAST(`AUTO_ID` AS STRING),
CAST(`HOSP_NAME` AS STRING),
CAST(`HOSP_ID` AS STRING),
CAST(`PATIENT_ID` AS STRING),
CAST(`LK_CLI_REG` AS STRING),
CAST(`CREATE_DTIME` AS STRING),
CAST(`UPDATE_DTIME` AS STRING),
CAST(`RECORD_DTIME` AS STRING),
CAST(`RECORD_UPDATE_DTIME` AS STRING),
CAST(`CASE_TYPE` AS STRING) FROM DTable
        ]]>
    </sql>
</sqls>
