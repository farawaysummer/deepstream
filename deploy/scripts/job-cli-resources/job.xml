<?xml version="1.0" encoding="UTF-8" ?>
<job name="三院就诊业务作业">
    <!--捕获的变更事件相关配置-->
    <events>
        <event name="queryEvent">
            <!--数据变更事件的索引字段信息-->
            <eventKeys>
                <field name="CLINIC_ID" type="STRING" isKey="true"/>
            </eventKeys>
            <!--读取的事件来源类型，一般为kafka或jdbc-cdc-->
            <eventType name="kafka">
                <!--读取的kafka主题名-->
                <config name="topic" value="7"/>
                <!--kafka的服务地址-->
                <config name="properties.bootstrap.servers" value="localhost:9092"/>
                <!--kafka的读取分组，默认即可-->
                <config name="properties.group.id" value="k_default"/>
                <!--kafka的读取偏移量设置，调试阶段可设置为earliest-offset , 正式运行时设置为group-offsets-->
                <config name="scan.startup.mode" value="latest-offset"/>
                <!--kafka的读取格式，从CDC的数据主题中读取格式为ruisoft-koalaspeed-->
                <config name="format" value="ruisoft-koalaspeed"/>
            </eventType>
            <!--延迟重试配置-->
            <delayRetry enabled="true" >
                <!--delayLevel: 延迟重试等级， 级别为LOW, MEDIUM, HIGH 对应的延迟重试时间为1分钟，3分钟，10分钟 -->
                <config delayLevel="MEDIUM" servers="localhost:9092" deadline="10" target="7"/>
                <policy checkEmpty="true" checkRequired="true"/>
            </delayRetry>
        </event>
    </events>
    <!--处理过程中涉及到的表定义-->
    <relates>
        <!--表定义，包括表名和引用的字段定义，引用名与同目录下的table-*.xml文件相同-->
        <table name="S_CLI_SEERECORD" ref="s_cli_seerecord">
<!--            &lt;!&ndash;表与真实物理数据存储的映射，类型为jdbc意味着这张表与真实数据库中的某张表形成了映射关系&ndash;&gt;-->
<!--            <tableType name="jdbc">-->
<!--                &lt;!&ndash;连接信息&ndash;&gt;-->
<!--                <config name="url" value="jdbc:mysql://10.48.251.50:3306/ods?useSSL=false&amp;autoReconnect=true"/>-->
<!--                &lt;!&ndash;用户名&ndash;&gt;-->
<!--                <config name="username" value="ruisoft"/>-->
<!--                &lt;!&ndash;密码&ndash;&gt;-->
<!--                <config name="password" value="Ruisoft@123"/>-->
<!--                &lt;!&ndash;驱动类名&ndash;&gt;-->
<!--                <config name="driver" value="com.mysql.cj.jdbc.Driver"/>-->
<!--                &lt;!&ndash;真实表名&ndash;&gt;-->
<!--                <config name="table-name" value="s_cli_seerecord"/>-->
<!--            </tableType>-->
            <tableType name="upsert-kafka">
                <!--读取的kafka主题名-->
                <config name="topic" value="s_cli_seerecord"/>
                <!--kafka的服务地址-->
                <config name="properties.bootstrap.servers" value="10.48.251.50:9092"/>
                <!--kafka的读取分组，默认即可-->
                <config name="properties.group.id" value="cli_group"/>
                <!--kafka的读取格式，从CDC的数据主题中读取格式为ruisoft-koalaspeed-->
                <config name="key.format" value="json"/>
                <config name="value.format" value="json"/>
            </tableType>
        </table>
    </relates>
    <process>
        <datasource name="HIS"/>
        <processSQL name="selectHIS"/>
        <sinkSQL name="insert"/>
        <transformJobs/>
        <delayQuerySecond>1</delayQuerySecond>
        <results>
            <field name="AUTO_ID" type="VARCHAR2"/>
            <field name="BASE_ID" type="VARCHAR2"/>
            <field name="LP_CLI_SEE" type="VARCHAR2"/>
            <field name="LK_CLI_SEE" type="VARCHAR2"/>
            <field name="LK_CLI_REG" type="VARCHAR2"/>
            <field name="LK_MPI_PATIENT" type="VARCHAR2"/>
            <field name="PATIENT_ID" type="VARCHAR2"/>
            <field name="OUTP_ID" type="VARCHAR2"/>
            <field name="OUTP_NO" type="VARCHAR2"/>
            <field name="NAME" type="VARCHAR2"/>
            <field name="CLI_DEPT_CODE" type="VARCHAR2"/>
            <field name="CLI_DEPT_NAME" type="VARCHAR2"/>
            <field name="CLI_DTIME" type="TIMESTAMP"/>
            <field name="CLI_DOCT_CODE" type="VARCHAR2"/>
            <field name="CLI_DOCT_NAME" type="VARCHAR2"/>
            <field name="DIAG_CODE" type="VARCHAR2"/>
            <field name="DIAG_NAME" type="VARCHAR2"/>
            <field name="CHIEF_COMPLIANT" type="CHAR"/>
            <field name="SYMPTOM_CODE" type="VARCHAR2"/>
            <field name="SYMPTOM_NAME" type="VARCHAR2"/>
            <field name="MEDICAL_HISTORY" type="CHAR"/>
            <field name="ALLERGIC_HISTORY" type="CHAR"/>
            <field name="CHECK_UP" type="CHAR"/>
            <field name="TREATMENT_PLAN" type="CHAR"/>
            <field name="SBP" type="CHAR"/>
            <field name="DBP" type="CHAR"/>
            <field name="HEIGHT" type="VARCHAR2"/>
            <field name="WEIGHT" type="VARCHAR2"/>
            <field name="CONSULT_QUESTION" type="CHAR"/>
            <field name="HEALTH_REQUEST" type="CHAR"/>
            <field name="HEALTH_EVALUATION" type="CHAR"/>
            <field name="OTHER_MEDICAL_TREATMENT" type="CHAR"/>
            <field name="DIAG_CODING_TYPE" type="CHAR"/>
            <field name="DIAG_NOTE" type="CHAR"/>
            <field name="REFERRAL_FLAG" type="CHAR"/>
            <field name="REFERRAL_NOTE" type="CHAR"/>
            <field name="OTHER_DIAG_CODE" type="CHAR"/>
            <field name="OTHER_DIAG_NAME" type="CHAR"/>
            <field name="INFECTIOUS_FLAG" type="CHAR"/>
            <field name="CHRONIC_FLAG" type="VARCHAR2"/>
            <field name="TEMP" type="VARCHAR2"/>
            <field name="PULSE_CONDITION" type="CHAR"/>
            <field name="HEART_RATE" type="CHAR"/>
            <field name="PAST_HISTORY" type="CHAR"/>
            <field name="GETILL_DTIME" type="TIMESTAMP"/>
            <field name="DIAG_DTIME" type="CHAR"/>
            <field name="PATIENT_GONE" type="CHAR"/>
            <field name="PATIENT_GONE_OTHER" type="CHAR"/>
            <field name="CLINIC_END_TIME" type="TIMESTAMP"/>
            <field name="OUTHOS_RESULT_CODE" type="CHAR"/>
            <field name="OUTHOS_RESULT_NAME" type="CHAR"/>
            <field name="CREATE_DTIME" type="TIMESTAMP"/>
            <field name="UPDATE_DTIME" type="TIMESTAMP"/>
            <field name="RECORD_DTIME" type="CHAR"/>
            <field name="RECORD_UPDATE_DTIME" type="CHAR"/>
        </results>
    </process>

</job>